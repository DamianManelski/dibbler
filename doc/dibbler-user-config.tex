%%
%% $Id: dibbler-user-config.tex,v 1.10 2004-12-01 20:55:49 thomson Exp $
%%

\section{Config files}

This section describes Dibbler server and (optional) client
configuration. Square brackets denotes optional values: mandatory
[optional]. Alternative is marked as $\mid$. A $\mid$ B means A or B.

Parsers are case-insensitive, so Iface, IfAcE, iface and IFACE mean the
same. This does not apply to interface names, of course. eth0 and ETH0
are dwo diffrent interfaces.

\subsection{Tokens and basic informations}
Config file parsing is token-based. Here's list of tokens used:
\begin{description}
\item[IPv6 address] -- IPv6 address 
\item[32-bit decimal integer] -- string containing only numbers, e.g. 123456
\item[string] -- string of arbitrary characters enclosed in single or double
  quotes, e.g. 'this is string'. If string contains only a-z, A-Z and
  0-9 characters, quotes can be omited.
\item[DUID identifier] -- hex number starting with 0x, e.g. 0x12abcd.
\item[IPv6 address list] -- IPv6 addresses separated with commas.
\item[DUID list] -- DUIDs separated with commas.
\item[string list] -- strings separated with comas.
\item[Boolean] -- YES, NO, TRUE, FALSE, 0 or 1. Each of them can be
  used, when user must enable or disable specific option.
\end{description}

There are also some client or server specified tokens. Here's the list:
\begin{description}
\item[client] -- iface, address, ia, no-ia, log-mode, log-name,
  log-level, work-dir, prefered-lifetime, valid-lifetime, t1, t2,
  reject-servers, prefered-servers, rapid-commit, unicast, sip-server,
  sip-domain, nis-server, nis-domain, nis+-server, nis+-domain,
  lifetime, dns-server, domain, ntp-server, time-zone,

\item[server] -- iface, class, log-level, log-name, log-level,
  work-dir, accept-only, reject-only, t1, t2, prefered-lifetime,
  valid-lifetime, unicast, preference, pool, rapid-commit,
  client-max-lease, class-max-lease, iface-max-lease, dns-servers,
  domain, ntp-server, time-zone, sip-server, sip-domain, nis-server,
  nis-domain, nis+-server, nis+-domain, lifetime
\end{description}

\subsection{Scopes}
There are four scopes, in which options can be specified:
\begin{itemize}
\item global
\item inteface
\item IA
\item address
\end{itemize}

Global scope is the largest. It covers the whole config file and
applies to all intefaces, IAs, and addresses, until some lower scope
options override it. Next comes inteface scope. Options defined there
are inteface-specific and apply to this interface, all IAs in this
interface and addresses in those IAs. Next is IA scope. Options
defined there are IA-specific and apply to this IA and to addresses it
contains. Least significant scope is address. Every option is specific
for one scope. For example, T1 is defined for
IA scope. However, it can be also used in more common scopes. In this
case -- in interface or global. Defining T1 in interface scope means:
,,for this interface default value for T1 is ...''. The same applies
to global scope. Options can be used multiple times. In that case
value defined later is used.

\subsection{Comments}

Comments are also allowed. All common comment styles are supported:
\begin{itemize}
\item C++ style one-line comments: // this is comment
\item C style multi-line comments: /* this is multiline comment */
\item bash style one-line comments: \# this is one-line comment
\end{itemize}

\subsection{Client config file}

Client config file should be named \verb+client.conf+. After
successful startup, old version of this file is stored as
\verb+client.conf-old+. One of design requirements for client was
,,out of the box'' usage. To achieve this, simply use empty
\verb+client.conf+ file. Client will try to get one address for each up and
running interface \footnote{Exactly: Client tries to configure each
  up, multicast-capable and running interface, which has link address
  at least 6 bytes long. So it will not configure tunnels (which
  usually have IPv4 address (4bytes long) as their link address. It
  should configure all Ethernet and 802.11 interfaces. The latter was
  not tested by author due to lack of access to 802.11 equipment.}.

\subsubsection{Global scope}

Every option can be declared in global scope.
Config file has this form:

\begin{verbatim}
interface declaration | 
global options        | 
interface options     |
IA options            |
address options
\end{verbatim}

\subsubsection{Interface declaration}

Interface can be declared this way:
\begin{verbatim}
iface name_of_this_interface
{
  interface options      |
  IA options             |
  address options        
}
\end{verbatim}

or 

\begin{verbatim}
iface number 
{
  interface options      |
  IA options             |
  address options        
}
\end{verbatim}

In every case, number denotes interface number. It can be extracted
from ,,ip~l'' (Linux) or
,,ipv6~if''(Windows). \verb+name_of_this_interface+ is an interface
name.  Also take a note that name of the interface
no longer needs to be enclosed in single or double quotes. It is
necessary only in Windows systems, where interface names sometimes
contain spaces, e.g. ''local network connection''.

\subsubsection{IA declaration}

IA is declared this way:

\begin{verbatim}
ia [number]
[{ 
  [address declaration   | 
   IA options            | 
   address options       ] 
   ...          
}]
\end{verbatim}

where number is an optional number, which describes how many such IAs
should be requested. If this number is not equal 1, then address
options are not allowed. That could come in handy when someone need
serveral IAs with the same parameters. If IA contains no addresses,
client assumes that one address should be configured.


\subsubsection{Address declaration}
Addres is declared like this:

\begin{verbatim}
address [number] 
[{ 
	[address options   |
	IPv6 address    ] 
}]
\end{verbatim}
where number denotes how many addresses with those values should be
requested. If it is diffrent than 1, then IPv6 address options are not
allowed.

\subsubsection{Standard options}
Standard options are... well, standard. This means that they have 
nothing to do with any extensions. Standard options are declared this way:

\begin{verbatim}
OptionName option-value
\end{verbatim}

Every option has a scope it can be used in, default value and
sometimes allowed range. Parameters denoted with (H) are used as hints
for the server. Value of \opt{work-dir} option is currently not
used. In \opt{log-mode} option, \verb+short+ and \verb+full+ values are
supported. \verb+syslog+ and \verb+eventlog+ will be available in
future releases. rapid-commit and unicast expect one boolean
parameter. It can be TRUE, FALSE, YES, NO, 0 or 1. Setting log level
to too low value (5 or less) can result in mysterious behavior. 6 or 7
is a recommended value.

\begin{center}
\begin{tabular}{|c|c|>{\centering}p{1.7cm}<{}|c|p{6cm}|}
\hline
Name              & Scope   & Values     & default    & Description \\
                  &         & (default)  &            & \\
\hline
valid-lifetime    & address & integer    & 4294967296 & valid lifetime for address (specified in seconds) (H)\\
prefered-lifetime & address & integer    & 4294967296 & after this amount of time(in seconds) address becomes depreciated (H)\\
T1                & IA      & integer    & 4294967296 & client should renew addresses after T1 seconds (H)\\
T2                & IA      & integer    & 4294967296 & client should send REBIND after T2 seconds (H)\\
reject-servers    & IA      & addrs or
                             DUID list  & empty      & list containing servers which should be discarded in configuration of this IA \\
prefered-servers  & IA      & addrs or 
                             DUID list  & empty      & Prefered servers list. ADVERTISE messages received by client are sorted according to this list. \\
rapid-commit      &interface& 0 or 1     & 0          & should we use Rapid Commit? \\
unicast           &interface& 0 or 1     & 0          & Is unicast communication allowed? \\
work-dir          & global  & string     & empty      & working directory \\
log-level         & global  & 1-8        & 8          & log-level (8 is most verbose) \\
log-name          & global  & string     & Client     & Name, which appears in a log file\\
log-mode          & global  &short or full& full      & logging mode: short (date and name suppressed) or full. \\
\hline
\end{tabular}
\end{center}

\subsubsection{Addional options}
Additional options are the options specified in external drafts and in RFC
documents. They are declared with \verb+option+ keyword:

\begin{verbatim}
option OptionName option-value
\end{verbatim}

where OptionName is one of possible values listed below:

\begin{center}
\begin{tabular}{|c|c|>{\centering}p{1.7cm}<{}|c|p{6cm}|}
\hline
OptionName     & Scope    & Values      &default& Description \\
               &          & (default)   &       & \\
\hline
dns-server     & interface& addrs list  & empty & preferred DNS servers list (H) \\
domain         & interface&domains list & empty & preferred domain (H)\\
ntp-server     & interface& addrs list  & empty & preferred NTP servers list (H)\\
time-zone      & interface& timezone    & empty & preferred time zone (H)\\
sip-server     & interface& addrs list  & empty & preferred SIP servers list (H)\\
sip-domain     & interface&domains list & empty & preferred SIP domain (H)\\
nis-server     & interface& addrs list  & empty & preferred NIS servers list (H)\\
nis-domain     & interface& domain      & empty & preferred NIS domain (H)\\
nis+-server    & interface& addrs list  & empty & preferred NIS+ servers list (H)\\
nis+-domain    & interface& domain      & empty & preferred NIS+ domain (H)\\
lifetime       & interface& YES/NO      & no    & Should client request lifetime option? \\
\hline
\end{tabular}
\end{center}

Note that timezone format is described in file \verb+draft-ietf-dhc-dhcpv6-opt-tz-00.txt+
and domain format is described in RFC 3646. After receiving options
values from a server, client stores them in separate files in the
working directory, e.g. \verb+option-dns-server+. Several options
are processed and set up in the system. Options supported in Linux and
Windows environments are presented in the table below.

\begin{center}
\begin{tabular}{|l|l|l|}
\hline
Option & Support (Linux) & Support (winXP/2003)  \\
\hline
dns-server  & system, file & system, file \\
domain      & file         & system, file \\
ntp-server  & file         & file \\
time-zone   & file         & file \\
sip-server  & file         & file \\
sip-domain  & file         & file \\
nis-server  & file         & file \\
nis-domain  & file         & file \\
nis+-server & file         & file \\
nis+-domain & file         & file \\
\hline
\end{tabular}
\end{center}

\subsubsection{Stateless configuration}

If interface does not contain \verb+IA+ keyword, one IA with one address is
assumed. If client should not request for address on this interface,
\opt{stateless}\footnote{In the version 0.2.1-RC1 and earlier, this
  directive was called no-ia. This depreciated name is valid for now,
  but might be removed in future releases.}
must be used. In such circumstances, only specified options will be
requested.

\subsubsection{Example client config file}

In simplest case, client config can be empty. Client will try to
assign one address for every interface present in the system, except
interfaces:
\begin{itemize}
\item which are down (flag UP not set)
\item loopback (flag LOOPBACK set)
\item which are not running (flag RUNNING not set)
\item which are not multicast capable (flag MULTICAST not set)
\end{itemize}

If you must use DHCPv6 on one of such interfaces (which is not
recommended and probably will fail), you must explicitly specify this
interface in config file.

Simple config config file requesting 1 address and DNS configuration
on eth0 interface looks like that:
\begin{verbatim}
log-mode short
log-level 7
iface eth0 {
  option dns-server
  ia {
  }
}
\end{verbatim}

Another example is presented below. Client asks for 1 address and
would like it to be 2000::1:2:3. Rapid-commit is allowed and client
would like to renew this address once in a 10 minutes:

\begin{verbatim}
log-mode short
log-level 7
iface eth0 {
  rapid-commit YES
  ia {
    address { 
      2000::1:2:3
    }
  }
}
\end{verbatim}

Here's yet another example. We would like to obtain 2 addresses on
,,Local Area Connection'' interface. Unicast communication is ok in
this scenario. We don't care for details, so keep those log very
short. Config file looks like that:
\begin{verbatim}
log-mode short
log-level 3
iface "Local Area Connection" {
  ia {
    address
    address
  }
}
\end{verbatim}

Here is a more coplicated case. Let's say there are 4 interfaces,
numbered 1 thru 4. Interfaces 1,2 and 3 are not to be
configured. Interface 4, named eth0 should have 3 IAs. Two of them are
supposed to contain one address each. Third IA should contain 3
addresses. Addresses assigned to first and second IA should have
prefered-lifetime 1 hour and valid-lifetime 2 hours. This IA should
have 3 specific addresses: 2000::1, 2000::2 and 2000::3. Information
about NTP servers,our current timezone, available DNS servers and our
domain should also be retrived. Here's config file:

\begin{verbatim}
iface eth0
{
  valid-lifetime 7200    // default value - 2 hours
  prefered-lifetime 3600 // default value - 1 hour
  T1 600                 // request 10 minutes interval
  T2 1200		 /* trouble begins after 20 minutes
                            of server's silence */
  IA 2                   // 2 IAs with just specified values (1h/2h/10min/20min)
  IA			 // third IA is more specific
  {
    valid-lifetime 3600   	// valid lifetime changed to 1 hour
    prefered-lifetime 1800	// prefered lifetime changed to 30min
    address
    {			  
      2000::1		  // request those addresses
      2000::2             
      2000::3
    }
  }
  option ntp-servers       // ask for NTP servers
  option time-zone         // ask for timezone
  option dns-servers       // ask for DNS servers
  option domain            // ask for domain
}
\end{verbatim}

\subsection{Server config file}

Server configuration is stored in \verb+server.conf+ file. After
successful startup, old version of this file is stored as \verb+server.conf-old+.

\subsubsection{Global scope}

Every option can be declared in global scope.
Config file has this form:

\begin{verbatim}
 interface declaration  |
 global options         |
 interface options      |
 class options          
\end{verbatim}

\subsubsection{Interface declaration}

Interface can be declared this way:
\begin{verbatim}
iface name_of_this_interface
{
  interface options      |
  class options        
}
\end{verbatim}

or 

\begin{verbatim}
iface number 
{
  interface options      |
  class options        
}
\end{verbatim}

where name\_of\_this\_interface denotes name of the interface and
number denotes it's number. It no longer needs to be enclosed in
single or double quotes (except windows cases, when interface name
contains spaces).

\subsubsection{Class scope}
Address class is declared as follows:

\begin{verbatim}
class
{  
     class options |
     address poll    
}
\end{verbatim}

address poll has this format:
\begin{verbatim}
poll minaddress-maxaddress
\end{verbatim}

\subsubsection{Options}

Every option has a scope it can be used in, default value and
sometimes allowed range.

%% FIXME: this table must be sanitized
\begin{tabular}{|c|c|>{\centering}p{1.7cm}<{}|c|p{6cm}|}
\hline
Name             & Scope   & Values      & default    & Description \\
                 &         & (default)   &  & \\
\hline
work-dir         & global  & string      & empty      & working directory \\
log-level        & global  & 1-8         & 8          & log-level (8 is most verbose) \\
log-name         & global  & string      & Client     & Name, which appears in a log file\\
log-mode         & global  &short or full& full       & logging mode: short (date and name suppressed) or full \\

preference       &interface& 0-255       & 0          & server preference value (higher is more prefered) \\
unicast          &interface& address     & empty      & Specify which address should be used. \\
iface-max-lease  &interface& integer     & 4294967296 & how many addresses can be leased by all clients? \\
client-max-lease &interface& integer     & 4294967296 & how many addresses can be leased by one client? \\
rapid-commit     &interface& 0 or 1      & 0          & should we allow Rapid Commit (SOLICIT--REPLY)? \\

valid-lifetime   & class   & integer     & 4294967296 & valid lifetime for address (specified in seconds)\\
prefered-lifetime& class   & integer     & 4294967296 & after this amount of time(in seconds) address becomes depreciated\\
T1               & class   & integer     & 4294967296 & client should renew addresses after T1 seconds \\
T2               & class   & integer     & 4294967296 & client should send REBIND after T2 seconds\\
reject-clients   & class   & addrs or 
                             DUID list   & empty      & list containing servers which should be discarded in configuration of this IA \\
accept-only      & class   & addrs or
                             DUID list   & empty      & these are the only clients allowed to use this class\\
class-max-lease  & class   & integer     & 4294967296 & how many addresses can be leased from this class? \\
\hline
\end{tabular}

\subsubsection{Addional options}
Server supports additonal options, not specified in RFC3315. They have
generic form:

\begin{verbatim}
option OptionName OptionsValue
\end{verbatim}

All supported options are specified in the table below:

\begin{center}
\begin{tabular}{|l|l|c|c|l|}
\hline
OptionName       & OptionsValue& Default    & Description \\ \hline
dns-server       & addrs list  & empty      & DNS servers list \\
domain           & string list & empty      & domain names list \\
ntp-server       & addrs list  & empty      & NTP servers list \\
time-zone        & timezone    & empty      & time zone \\
sip-server       & addrs list  & empty      & SIP servers list \\
sip-domain       & string list & empty      & domain names list \\

nis-server       & addrs list  & empty      & NIS servers list \\
nis-domain       & string      & empty      & domain name \\

nisplus-server   & addrs list  & empty      & NIS+ servers list \\
nis-domain       & string      & empty      & domain name \\
lifetime         & integer     & empty      & how often renew options? \\
\hline
\end{tabular}
\end{center}

Lifetime is a special case. It is not set up by client in a system
configuration. It is, however, used by the client to know how long
obtained values are correct.

\subsubsection{Example server config file}

In opposite to client, server uses only interfaces described in config
file. Let's examine this common situation: server has interface
named \emph{eth0} (which is fourth interface in the system) and is
supposed to assign addresses from 2000::100/124 class. Simplest config
file looks like that:

\begin{verbatim}
iface eth0
{ 
  class
  {
    pool 2000::100-2000::10f
  } 
}
\end{verbatim}

Another example: Server should support 2000::0/120 class on eth0
interface. It should not allow any client to obtain more than 5
addresses and should not grant more then 50 addresses in total. And it
should have prefence set to 7, accept T1 from 1 to 2 minutes and so
on. Config file is presented below:

\begin{verbatim}
log-mode short
log-level 7
iface eth0
{
   iface-max-lease 50
   client-max-lease 5
   preference 7
   class
   {
       pool 2000::1-2000::100
   }
}  
\end{verbatim}

Here's modified previous example. Instead of specified limits, unicast
communication should be supported.

\begin{verbatim}
log-level 7
iface eth0
{
   unicast 2000::1234
   class
   {
       pool 2000::1-2000::100
   }
}  
\end{verbatim}

Ok, now let's present last config file with various requirements:
\begin{itemize}
\item Add new class on fifth interface named \emph{eth1}, for example 2000::fe00/120.
\item Rapit commit is allowed on eth1.
\item Server preference on this interface is set to maximum (255).
\item Assign 2000::20/124 class on fourth interface named
  eth0. Preference value for this interface should be 0.
\item Ignore client with DUID ``00001231200adeaaa'' in the class
  2000::20/124.
\item Valid and prefered lifetimes are 1 hour and 30 minutes
  respectively. T1 and T2 set to 10 minutes and 20 minutes.
\item For class 2000::100/124 valid and prefered lifetimes are 2 hours
  and 1 hour.
\item In class 2000::100/124 one client can request up to two
  addresses.
\item Do not assign more than 10 addresses from 2000::20/124 class.
\item Client with fe80::200:39ff:fe4b:1abc link-local address should
  get his static address 2000::2f.
\item We shall support DNS and NTP servers on interface 5. 
\item Log level is set to omit debug messages.
\end{itemize}

Here's config to do all this stuff:

\begin{verbatim}
log-level 7
valid-lifetime 3600
prefered-lifetime 1800
T1 600
T2 1200
iface eth0
{
  preference 0
  class
  {
    reject-clients ``00001231200adeaaa''
    2000::2f-2000::20  // it's in reverse order, but it works.
                       // just a trick. 
  }
  class
  {
    accept-only fe80::200:39ff:fe4b:1abc
    pool 2000::2f 
  }
}
iface 5
{
  dns-server 2000::123:456,2000::456:1234
  ntp-server 2000::1111:2222
  rapid-commit 1
  preference 255
  class
  {
    pool 2000::fe00-2000::feff
    class-max-lease 10
  }
  
  class
  {
    valid-lifetime 7200
    prefered-lifetime 3600
    pool 2000::100-2000::10f
    client-max-lease 2
  } 
}
\end{verbatim}

%% $Log: not supported by cvs2svn $
%% Revision 1.9  2004/11/02 00:02:23  thomson
%% Documentation improved.
%%
%% Revision 1.8  2004/10/25 20:45:54  thomson
%% Option support, parsers rewritten. ClntIfaceMgr now handles options.
%%
%% Revision 1.7  2004/09/05 15:27:49  thomson
%% Data receive switched from recvfrom to recvmsg, unicast partially supported.
%%
%% Revision 1.6  2004/07/05 00:53:03  thomson
%% Various changes.
%%
%% Revision 1.5  2004/06/28 22:38:00  thomson
%% Minor changes.
%%
%% Revision 1.4  2004/06/28 21:34:18  thomson
%% DUID is now parsed properly and SrvCfgMgr dumps valid xml file.
%%
%% Revision 1.3  2004/06/19 19:51:14  thomson
%% Various fixes.
%%
%% Revision 1.2  2004/06/19 10:24:59  thomson
%% Hyperlinks in PDF, building process modified
%%
